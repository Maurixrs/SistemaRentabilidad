
@{
    ViewBag.Title = "Nueva Planilla";
}
<style>
         #resumentabla td{line-height: 12px}

     #nueva td{line-height: 12px}
    #ingresotabla td{line-height: 12px}
        #encabezadostabla td{line-height: 12px}

    #costotabla td{line-height: 12px}
    #gastotabla td{line-height: 12px}
    #otrotabla td{line-height: 12px}
    #ingresotabla th{line-height: 12px}
    #costotabla th{line-height: 12px}
    #gastotabla th{line-height: 12px}
    #otrotabla th{line-height: 12px}
    #nueva th{line-height: 12px}
    #resumentabla th{line-height: 12px}
    #otrosub th{line-height: 12px}
    #encabezadostabla th{line-height: 12px}
    #totalingresotabla th{line-height: 12px}
      #totalgastotabla th{line-height: 12px}
        #totalcostotabla th{line-height: 12px}
          #totalotrotabla th{line-height: 12px}



    .table {
        margin-bottom: 0px;
    }
</style>

<head>

    <link href="/Content/site.css" rel="stylesheet">
</head>
@*///////////////////////////*@
<hr style="margin-top: 10px;margin-bottom: 10px;" />

<legend style="margin-bottom: 2px;">
    Planilla: @ViewBag.nsheet
</legend>
<table id="titulotabla" class="table table-condensed table-bordered chica">

    <thead class="tableStyle">


    <tr class="text-center">
        <th class="text-center">
            Descripción
        </th>

        <th class="text-center">
            Fecha de creación
        </th>
    </tr>
    </thead>
    <tbody>

    <td class="text-center">
        <input type="text" class="panel-info form-control-sm inputForm" id="wdescription" placeholder=""/>
    </td>
    <td class="text-center">
        <input type="date" class="panel-info form-control-sm inputForm" id="wdate" value="@DateTime.Now.ToString("yyyy-MM-dd")" placeholder="dd/mm/aaaa"/>
    </td>
    </tbody>

</table>
<hr style="margin-top: 2px;margin-bottom: 5px;border-style: dashed" />

<legend style="margin-bottom: 2px;background: cadetblue">
    Linea
</legend>
<table id="nueva" class="table table-condensed table-bordered chica" style="margin-bottom: 10px">
    <thead>
    <tr class="text-center" style="background: gainsboro">
        <th class="text-left" style="width: 40%">
            Descripción
        </th>
        <th class="text-left" style="width: 40%">
            Observación
        </th>

        <th class="text-left">
            Monto
        </th>
        <th class="text-center">
            Tipo
        </th>
    </tr>
    </thead>
    <tbody id="nueva">
    <td class="text-center fina">
        <input type="text" class="panel-info form-control-sm inputForm" id="ndescription" placeholder=""/>
        <span class="text-danger" style="display: block"></span>
    </td>
    <td class="text-center fina">
        <input type="text" class="panel-info form-control-sm inputForm" id="ncomment" placeholder=""/>
        <span class="text-danger" style="display: block"></span>
    </td>
    <td class="fina">
        <input type="number" class="panel-info form-control-sm inputForm" style="width: 100px" value="1" id="namount" onkeypress="solonumerosptocoma();"/>
        <span class="text-danger" style="display: block"></span>
    </td>
    <td>
        <div class="btn-group btn-group-justified" data-toggle="buttons" style="display: inline">
            <label class="btn btn-info btn-xs active" value="ing" onclick="acting(this)">
                <input type="radio" name="options" value="ing" onclick="acttipo(this)" autocomplete="off" checked>Ingreso
            </label>
            <label class="btn btn-info btn-xs" value="cos" onclick="actcos(this)">
                <input type="radio" name="options" value="cos" autocomplete="off">Costo
            </label>
            <label class="btn btn-info btn-xs" value="gas" onclick="actgas(this)">
                <input type="radio" name="options" value="gas" autocomplete="off">Gasto
            </label>
            <label class="btn btn-info btn-xs" value="otr" onclick="actotr(this)">
                <input type="radio" name="options" value="otr" autocomplete="off">Otro ing.
            </label>
        </div>
    </td>
    <td class="fina">
        <button type="button" id="addn" class="btn btn-success btn-xs add" value="nueva"/>
        <span class="glyphicon glyphicon-plus"></span>
    </td>
    </tbody>

</table>
<hr style="margin-top: 2px;margin-bottom: 5px;border-style: inset;border-width: thin;"/>
<table id="encabezadostabla" class="table table-condensed table-bordered chica" style="margin-bottom: 2px">
    <thead>
        <tr class="text-center" style="background: khaki">
            <th class="text-left" style="width: 40%">
                Descripción
            </th>
            <th class="text-left" style="width: 40%">
                Observación
            </th>

            <th class="text-left" style="width: 20%">
                Monto
            </th>

        </tr>
    </thead>
</table>
<hr style="margin-top: 2px;margin-bottom: 5px;border-style: dotted" />
<legend style="margin-bottom: 2px; background: darkkhaki">
    Ingresos
</legend>

<table id="ingresotabla" class="table table-condensed table-bordered chica">

    <tbody id="ingreso">
    <tr>
        <td style="width: 40%">-</td>
        <td style="width: 40%">-</td>
        <td>-</td>
    </tr>
    </tbody>

</table>
<table id="totalingresotabla" class="table table-condensed table-bordered chica" style="margin-bottom: 10px">
    <thead>
        <tr class="text-center" style="background: none">
            <th class="text-left" style="width: 40%; border-bottom: hidden; border-top: hidden;border-left:hidden">
                
            </th>
            <th class="text-right" style="width: 40%; font-weight: bolder;border-bottom: hidden; border-top: hidden; border-left: hidden;font-style: italic;font-size: medium;">
                Subtotal
            </th>

            <th class="text-left" style="background: lightgray" id="toting">
                0.00
            </th>
            <th style="width: 2%;border-bottom: hidden; border-top: hidden;border-right:hidden">
                
            </th>

        </tr>
    </thead>
</table>
<hr style="margin-top: 2px;margin-bottom: 5px;border-style: dashed" />

<legend style="margin-bottom: 2px;background: darkkhaki">
    Costos de las ventas
</legend>
<table id="costotabla" class="table table-condensed table-bordered chica">

    <tbody id="costo">
    <tr>
        <td style="width: 40%">-</td>
        <td style="width: 40%">-</td>
        <td>-</td>
    </tr>
    </tbody>

</table>
<table id="totalcostotabla" class="table table-condensed table-bordered chica" style="margin-bottom: 10px">
    <thead>
        <tr class="text-center" style="background: none">
            <th class="text-left" style="width: 40%; border-bottom: hidden; border-top: hidden;border-left:hidden">

            </th>
            <th class="text-right" style="width: 40%; font-weight: bolder;border-bottom: hidden; border-top: hidden; border-left: hidden;font-style: italic;font-size: medium;">
                Subtotal
            </th>

            <th class="text-left" style="background: lightgray"  id="totcos">
                0.00
            </th>
            <th style="width: 2%;border-bottom: hidden; border-top: hidden;border-right:hidden">

            </th>

        </tr>
    </thead>
</table>
<hr style="margin-top: 2px;margin-bottom: 5px;border-style: dashed" />

<legend style="margin-bottom: 2px;background: darkkhaki">
    Gastos
</legend>
<table id="gastotabla" class="table table-condensed table-bordered chica">

    <tbody id="gasto">
    <tr>
        <td style="width: 40%">-</td>
        <td style="width: 40%">-</td>
        <td>-</td>
    </tr>
    </tbody>

</table>
<table id="totalgastotabla" class="table table-condensed table-bordered chica" style="margin-bottom: 10px">
    <thead>
        <tr class="text-center" style="background: none">
            <th class="text-left" style="width: 40%; border-bottom: hidden; border-top: hidden;border-left:hidden">

            </th>
            <th class="text-right" style="width: 40%; font-weight: bolder;border-bottom: hidden; border-top: hidden; border-left: hidden;font-style: italic;font-size: medium;">
                Subtotal
            </th>

            <th class="text-left" style="background: lightgray"  id="totgas">
                0.00
            </th>
            <th style="width: 2%;border-bottom: hidden; border-top: hidden;border-right:hidden">

            </th>

        </tr>
    </thead>
</table>
<hr style="margin-top: 2px;margin-bottom: 5px;border-style: dashed" />

<legend style="margin-bottom: 2px;background: darkkhaki">
    Otros ingresos
</legend>
<table id="otrotabla" class="table table-condensed table-bordered chica">

    <tbody id="otro">
    <tr>
        <td style="width: 40%">-</td>
        <td style="width: 40%">-</td>
        <td>-</td>
    </tr>
    </tbody>
</table>
<table id="totalotrotabla" class="table table-condensed table-bordered chica" style="margin-bottom: 10px">
    <thead>
        <tr class="text-center" style="background: none">
            <th class="text-left" style="width: 40%; border-bottom: hidden; border-top: hidden;border-left:hidden">

            </th>
            <th class="text-right" style="width: 40%; font-weight: bolder;border-bottom: hidden; border-top: hidden; border-left: hidden;font-style: italic;font-size: medium;">
                Subtotal
            </th>

            <th class="text-left" style="background: lightgray"  id="tototr">
                0.00
            </th>
            <th style="width: 2%;border-bottom: hidden; border-top: hidden;border-right:hidden">

            </th>

        </tr>
    </thead>
</table>

<hr style="margin-top: 2px;margin-bottom: 5px;border-style: dashed" />


<div>
    <div id="orderItemsi">
    </div>
    <span class="text-danger" style="display: block"></span>

</div>
<div>
    <div id="orderItemsc">
    </div>
    <span class="text-danger" style="display: block"></span>

</div>
<div>
    <div id="orderItemsg">
    </div>
    <span class="text-danger" style="display: block"></span>

</div>
<div>
    <div id="orderItemso">
    </div>
    <span class="text-danger" style="display: block"></span>

</div>
<legend style="margin-bottom: 2px;background: darkkhaki">
    Resumen
</legend>
<table id="resumentabla" class="table table-condensed   table-striped table-bordered chica">

    <thead class="tableStyle">
        <tr class="text-center" style="background: khaki">
            <td class="text-left" style="border-radius: 3px; font-weight: bold">
                Observaciones
            </td>
            <td class="text-left" style="border-radius: 3px; width: 200px; font-weight: bold">
                Total
            </td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                <textarea type="text" class="panel-info form-control-sm" id="wcomments"placeholder=""></textarea>

            </td>
            <td>
                <input type="text" class="panel-info text-center" value="0.00" id="wtotal" placeholder="" />
                <span class="text-danger" style="display: block"></span>
            </td>
        </tr>

    </tbody>

</table>

<hr style="color: grey" />


<div class="text-center">
    <button type="button" id="submit" class="btn btn-success btn-md" value="Guardar">
        Guardar
        <span class="glyphicon glyphicon-floppy-disk"></span>
    </button>
    <button type="button" id="imprimir" class="btn btn-success btn-md" value="Guardar">
        Guardar e Imprimir
        <span class="glyphicon glyphicon-floppy-disk"></span>
    </button>

</div>











@section Scripts{





    <script src="@Url.Content("~/Scripts/solonumerosptocoma.js")"></script>


    <script>
        function calculogral() {
            tgral = 0;
            $.each(toting, function () { tgral += parseFloat(this) || 0; });
            $.each(tototr, function () { tgral += parseFloat(this) || 0; });
            $.each(totgas, function () { tgral -= parseFloat(this) || 0; });
            $.each(totcos, function () { tgral -= parseFloat(this) || 0; });
            document.getElementById("wtotal").value = tgral.toFixed(2);
        }
        function acting(a) { tipo = "ing"; }
        function actcos(a) { tipo = "cos"; }
        function actgas(a) { tipo = "gas"; }
        function actotr(a) { tipo = "otr"; }

        $(document).ready(function () {
            tipo = "ing";
         
            var orderItems = [];
            var orderItemsi = [];
            var orderItemsc = [];
            var orderItemsg = [];
            var orderItemso = [];
            toting = [];
            totcos = [];
            totgas = [];
            tototr = [];
            //////////ADD INGRESO///////////////
            ///////////////////////////
            //////////////////////
            //Add button click function
            
            $('#addn').click(function () {
             


                var isValidItem = true;

                //Check validation of order item
                if ($('#ndescription').val().trim() == '') {
                    isValidItem = false;
                    $('#ndescription').siblings('span.text-danger').html('Requerido');
                } else {
                    $('#ndescription').siblings('span.text-danger').html('');
                }

                if ($('#namount').val().trim() == '') {
                    isValidItem = false;
                    $('#namount').siblings('span.text-danger').html('Requerido');
                } else {
                    $('#namount').siblings('span.text-danger').html('');
                }


                if (isValidItem) {


                    var SheetDescription = $('#ndescription').val().trim();
                    var Amount = $('#namount').val().trim();
                    var Comments = $('#ncomment').val().trim();

                    if (tipo == "ing") {
                        var SheetType = 0;
                        orderItemsi.push({
                            SheetDescription: SheetDescription,
                            Amount: Amount,
                            Comments: Comments,
                            SheetType: SheetType
                        });
                        toting.push(
                              parseFloat(Amount)
                          );
                        toastr.info("-" + SheetDescription + "-<br/>Agregado.", "Ingreso:");
                        ingreso();
                    };
                    if (tipo == "cos") {
                        var SheetType = 1;
                        orderItemsc.push({
                            SheetDescription: SheetDescription,
                            Amount: Amount,
                            Comments: Comments,
                            SheetType: SheetType
                        });
                        totcos.push(
                             parseFloat(Amount)
                         );
                        toastr.info("-" + SheetDescription + "-<br/>Agregado.", "Costo:");
                        costo();
                    };
                    if (tipo == "gas") {
                        var SheetType = 3;
                        orderItemsg.push({
                            SheetDescription: SheetDescription,
                            Amount: Amount,
                            Comments: Comments,
                            SheetType: SheetType
                        });
                        totgas.push(
                             parseFloat(Amount)
                         );
                        toastr.info("-" + SheetDescription + "-<br/>Agregado.", "Gasto:");
                        gasto();
                    };
                    if (tipo == "otr") {
                        var SheetType = 4;
                        orderItemso.push({
                            SheetDescription: SheetDescription,
                            Amount: Amount,
                            Comments: Comments,
                            SheetType: SheetType
                        });
                        tototr.push(
                             parseFloat(Amount)
                         );
                        toastr.info("-" + SheetDescription + "-<br/>Agregado.", "Otro ingreso:");
                        otro();
                    };
                    $('#ndescription,#namount,#ncomment').val('');
                  
                }


            });
          
            //Save button click function
            $('#submit').click(function() {
                //validation of order
                var isAllValid = true;
                //if (orderItems.length == 0) {
                //    $('#orderItems').html('<span class="text-danger">Por favor, agregue productos.</span>');
                //    isAllValid = false;
                //}


                if ($('#wdescription').val().trim() == '') {
                    $('#wdescription').siblings('span.error').css('visibility', 'visible');
                    isAllValid = false;
                } else {
                    $('#wdescription').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#wdate').val().trim() == '') {
                    $('#wdate').siblings('span.error').css('visibility', 'visible');
                    isAllValid = false;
                } else {
                    $('#wdate').siblings('span.error').css('visibility', 'hidden');
                }
                if ($('#wtotal').val().trim() == '') {
                    $('#wtotal').siblings('span.error').css('visibility', 'visible');
                    isAllValid = false;
                } else {
                    $('#wtotal').siblings('span.error').css('visibility', 'hidden');
                }

                orderItems = $.merge(orderItemsi, orderItemsc);
                orderItems = $.merge(orderItems, orderItemsg);
                orderItems = $.merge(orderItems, orderItemso);
                //Save if valid
                if (isAllValid) {
                    var data = {
                        WorksheetDescription: $('#wdescription').val().trim(),
                        Date: $('#wdate').val().trim(),
                        Comments: $('#wcomments').val().trim(),
                        Sheets: orderItems,
                        Totali: $('#toting').html().trim(),
                        Totalc: $('#totcos').html().trim(),
                        Totalg: $('#totgas').html().trim(),
                        Totalo: $('#tototr').html().trim(),
                        TotalAmount: $('#wtotal').val().trim()
                    }

                    $(this).val('Please wait...');

                    $.ajax({
                        url: '@Url.Action("CreateWorksheet", "Worksheets")',
                        type: "POST",
                        data: JSON.stringify(data),
                        dataType: "JSON",
                        contentType: "application/json",
                        success: function(d) {
                            //check is successfully save to database
                            if (d.status == true) {

                                var url = '@Url.Action("Details", "Worksheets", new {id = ViewBag.nsheet})';
                                window.location.href = url;
                            } else {
                                alert('Failed');
                            }
                            $('#submit').val('Save');
                        },
                        error: function() {
                            alert('Error. Please try again.');
                            $('#submit').val('Save');
                        }
                    });
                }

            });


            function ingreso() {
               
                $('.elimi').remove();
                if (orderItemsi.length > 0) {
                    $('#orderItemsi').html('<span class="text-danger"></span>');
                    $.each(orderItemsi, function(i, val) {
                        var $rowi = $('<tr class="elimi"  style="background-color: white"></tr>');
                        $rowi.append($('<td style="width: 40%"></td>').html(val.SheetDescription));
                        $rowi.append($('<td style="width: 40%"></td>').html(val.Comments));
                        $rowi.append($('<td></td>').html(val.Amount));
                        var $removei = $('<a style="color:red" href="#">X</a>');
                        //CALCULO TOTAL ing
                        ting = 0;
                        $.each(toting, function () { ting += parseFloat(this) || 0; });
                        $('#toting').html(ting.toFixed(2));
                        //FIN CALCULO TOTAL ing
                        //calculo total gral
                        calculogral();
                        //fin calculo total gral
                        $removei.click(function (e) {
                            toastr.warning("-" + val.SheetDescription + "-<br/>Eliminado.", "Ingreso:");
                            e.preventDefault();
                            orderItemsi.splice(i, 1);
                            toting.splice(i, 1);
                            ingreso();
                            //CALCULO TOTAL ing
                            ting = 0;
                            $.each(toting, function () { ting += parseFloat(this) || 0; });
                            $('#toting').html(ting.toFixed(2));
                            //FIN CALCULO TOTAL ing
                            //calculo total gral
                            calculogral();
                            //fin calculo total gral
                        });
                        $rowi.append($('<td style="width:2%"></td>').append($removei));
                        $('#ingresotabla > tbody:last').append($rowi);
                    });
                } else {
                    $('#orderItemsi').html('');
                }
            }

            function costo() {
               
                $('.elimc').remove();
                if (orderItemsc.length > 0) {
                    $('#orderItemsc').html('<span class="text-danger"></span>');
                    $.each(orderItemsc, function(i, val) {
                        var $rowc = $('<tr class="elimc"  style="background-color: white"></tr>');
                        $rowc.append($('<td style="width: 40%"></td>').html(val.SheetDescription));
                        $rowc.append($('<td style="width: 40%"></td>').html(val.Comments));
                        $rowc.append($('<td></td>').html(val.Amount));
                        var $removec = $('<a style="color:red" href="#">X</a>');
                        //CALCULO TOTAL cos
                        tcos = 0;
                        $.each(totcos, function () { tcos += parseFloat(this) || 0; });
                        $('#totcos').html(tcos.toFixed(2));
                        //FIN CALCULO TOTAL cos
                        //calculo total gral
                        calculogral();
                        //fin calculo total gral
                        $removec.click(function (e) {
                            toastr.warning("-" + val.SheetDescription + "-<br/>Eliminado.", "Costo:");
                            e.preventDefault();
                            orderItemsc.splice(i, 1);
                            totcos.splice(i, 1);
                            costo();
                            //CALCULO TOTAL cos
                            tcos = 0;
                            $.each(totcos, function () { tcos += parseFloat(this) || 0; });
                            $('#totcos').html(tcos.toFixed(2));
                            //FIN CALCULO TOTAL cos
                            //calculo total gral
                            calculogral();
                            //fin calculo total gral
                        });
                        $rowc.append($('<td style="width: 2%"></td>').append($removec));
                        $('#costotabla > tbody:last').append($rowc);
                    });
                } else {
                    $('#orderItemsc').html('');
                }
            }

            function gasto() {
           
                $('.elimg').remove();
                if (orderItemsg.length > 0) {
                    $('#orderItemsg').html('<span class="text-danger"></span>');
                    $.each(orderItemsg, function(i, val) {
                        var $rowg = $('<tr class="elimg"  style="background-color: white"></tr>');
                        $rowg.append($('<td style="width: 40%"></td>').html(val.SheetDescription));
                        $rowg.append($('<td style="width: 40%"></td>').html(val.Comments));
                        $rowg.append($('<td></td>').html(val.Amount));
                        var $removeg = $('<a style="color:red" href="#">X</a>');
                        //CALCULO TOTAL gas
                        tgas = 0;
                        $.each(totgas, function () { tgas += parseFloat(this) || 0; });
                        $('#totgas').html(tgas.toFixed(2));
                        //FIN CALCULO TOTAL gas
                        //calculo total gral
                        calculogral();
                        //fin calculo total gral
                        $removeg.click(function (e) {
                            toastr.warning("-" + val.SheetDescription + "-<br/>Eliminado.", "Gasto:");
                            e.preventDefault();
                            orderItemsg.splice(i, 1);
                            totgas.splice(i, 1);
                            gasto();
                            //CALCULO TOTAL gas
                            tgas = 0;
                            $.each(totgas, function () { tgas += parseFloat(this) || 0; });
                            $('#totgas').html(tgas.toFixed(2));
                            //FIN CALCULO TOTAL gas
                            //calculo total gral
                            calculogral();
                            //fin calculo total gral
                        });
                        $rowg.append($('<td style="width: 2%"></td>').append($removeg));
                        $('#gastotabla > tbody:last').append($rowg);
                    });
                } else {
                    $('#orderItemsg').html('');
                }
            }

            function otro() {
                
                $('.elimo').remove();
                if (orderItemso.length > 0) {
                    $('#orderItemso').html('<span class="text-danger"></span>');
                    $.each(orderItemso, function(i, val) {
                        var $rowo = $('<tr class="elimo"  style="background-color: white"></tr>');
                        $rowo.append($('<td style="width: 40%"></td>').html(val.SheetDescription));
                        $rowo.append($('<td style="width: 40%"></td>').html(val.Comments));
                        $rowo.append($('<td></td>').html(val.Amount));
                        var $removeo = $('<a style="color:red" href="#">X</a>');
                        //CALCULO TOTAL otr
                        totr = 0;
                        $.each(tototr, function () { totr += parseFloat(this) || 0; });
                        $('#tototr').html(totr.toFixed(2));
                        //FIN CALCULO TOTAL otr
                        //calculo total gral
                        calculogral();
                        //fin calculo total gral
                     
                        $removeo.click(function (e) {
                            toastr.warning("-"+val.SheetDescription+"-<br/>Eliminado.","Otro ingreso:");
                            e.preventDefault();
                            orderItemso.splice(i, 1);
                            tototr.splice(i, 1);
                            otro();
                            //CALCULO TOTAL otr
                            totr = 0;
                            $.each(tototr, function () { totr += parseFloat(this) || 0; });
                            $('#tototr').html(totr.toFixed(2));
                            //FIN CALCULO TOTAL otr
                            //calculo total gral
                            calculogral();
                            //fin calculo total gral
                        });
                        $rowo.append($('<td style="width: 2%"></td>').append($removeo));
                        $('#otrotabla > tbody:last').append($rowo);
                      
                    });
                } else {
                    $('#orderItemso').html('');
                }
            }


        });
    </script>
}

<style>
    /*Adding some css for looks good*/
    span.error {
        display: block;
        visibility: hidden;
        color: #b94a48;
        font-size: 90%;
    }


    /*css for table*/
    .container td {
        vertical-align: top;
    }

    .tablecontainer table {
        width: 100%;
        border-collapse: collapse;
        border-top: 1px solid #BFAEAE;
        border-right: 1px solid #BFAEAE;
    }

    .tablecontainer th {
        border-bottom: 2px solid #BFAEAE !important;
    }

    .tablecontainer th, .tablecontainer td {
        text-align: left;
        border-left: 1px solid #BFAEAE;
        padding: 5px;
        border-bottom: 1px solid #BFAEAE;
    }

    .ui-widget {
        font-size: 12px !important;
    }
</style>

